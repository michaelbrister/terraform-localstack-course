name: ci

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    env:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform fmt/validate (backend disabled)
        run: |
          set -e
          dirs="01-local-basics 02-language-basics 03-for-each-patterns 04-dynamic-patterns 05-backend-bootstrap 06-state-migration 07-modules"
          for d in $dirs; do
            echo "== $d =="
            terraform -chdir=$d fmt -check
            terraform -chdir=$d init -backend=false
            terraform -chdir=$d validate
          done

          for env in dev stage prod; do
            echo "== live/$env =="
            terraform -chdir=live/$env fmt -check
            terraform -chdir=live/$env init -backend=false
            terraform -chdir=live/$env validate
          done

      # -----------------------------
      # Conftest (OPA) Policy Gating
      # -----------------------------
      - name: Install conftest
        run: |
          set -e
          curl -L -o conftest.tar.gz https://github.com/open-policy-agent/conftest/releases/download/v0.56.0/conftest_0.56.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/conftest
          conftest --version

      - name: Policy check (conftest on plan JSON)
        run: |
          set -e
          mkdir -p conftest-plans
          dirs="03-for-each-patterns 04-dynamic-patterns 07-modules"
          for d in $dirs; do
            echo "== conftest $d =="

            # init without backend, generate a plan, convert to JSON
            terraform -chdir=$d init -backend=false
            terraform -chdir=$d plan -out=tfplan -lock=false
            terraform -chdir=$d show -json tfplan > conftest-plans/${d//\//_}.tfplan.json

            # policy evaluation
            conftest test conftest-plans/${d//\//_}.tfplan.json -p policy
          done

      - name: Upload conftest plan JSON artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conftest-plans
          path: conftest-plans/*.tfplan.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Terratest
        run: |
          cd 11-terratest/test
          go mod tidy
          go test -v -timeout 25m