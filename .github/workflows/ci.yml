name: ci

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    env:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # -------------------------
      # Terraform fmt / validate
      # -------------------------
      - name: Terraform fmt & validate (backend disabled)
        run: |
          set -e
          dirs="01-local-basics 02-language-basics 03-for-each-patterns 04-dynamic-patterns 05-backend-bootstrap 06-state-migration 07-modules"
          for d in $dirs; do
            echo "== $d =="
            terraform -chdir=$d fmt -check
            terraform -chdir=$d init -backend=false -input=false
            terraform -chdir=$d validate
          done

          for env in dev stage prod; do
            echo "== live/$env =="
            terraform -chdir=live/$env fmt -check
            terraform -chdir=live/$env init -backend=false -input=false
            terraform -chdir=live/$env validate
          done

      # -------------------------
      # Conftest (policy as code)
      # -------------------------
      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_$(uname -s)_$(uname -m).tar.gz \
            | tar xz
          sudo mv conftest /usr/local/bin/conftest
          conftest --version

      - name: Terraform plan + Conftest
        run: |
          set -e
          mkdir -p conftest-plans

          dirs="03-for-each-patterns 04-dynamic-patterns 07-modules"
          for d in $dirs; do
            echo "== Policy check: $d =="
            terraform -chdir=$d init -backend=false -input=false
            terraform -chdir=$d plan -no-color -input=false -lock=false -out=tfplan
            terraform -chdir=$d show -no-color -json tfplan > conftest-plans/${d//\//_}.tfplan.json
            conftest test conftest-plans/${d//\//_}.tfplan.json -p policy
          done

      - name: Upload Conftest plan artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: conftest-plans
          path: conftest-plans

      # -------------------------
      # Terratest
      # -------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Terratest
        run: |
          cd 11-terratest/test
          go mod tidy
          go test -v -timeout 25m