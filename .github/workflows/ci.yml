name: ci

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to apply (dev|stage|prod)"
        required: true
        default: "dev"
      target_dir:
        description: "Directory to apply (e.g. live/dev)"
        required: true
        default: "live/dev"

env:
  AWS_ACCESS_KEY_ID: test
  AWS_SECRET_ACCESS_KEY: test
  AWS_DEFAULT_REGION: us-east-1

jobs:
  lint:
    name: lint (fmt/validate + tflint + trivy)
    runs-on: ubuntu-latest

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # --- fmt/validate (backend disabled) ---
      - name: Terraform fmt & validate
        run: |
          set -e
          dirs="01-local-basics 02-language-basics 03-for-each-patterns 04-dynamic-patterns 05-backend-bootstrap 06-state-migration 07-modules 08-terraform-console 09-refactor-state 10-breakfix 12-exam-drills 13-state-subcommands"
          for d in $dirs; do
            if [ -d "$d" ]; then
              echo "== $d =="
              terraform -chdir=$d fmt -check
              terraform -chdir=$d init -backend=false -input=false
              terraform -chdir=$d validate
            fi
          done

          for e in dev stage prod; do
            if [ -d "live/$e" ]; then
              echo "== live/$e =="
              terraform -chdir=live/$e fmt -check
              terraform -chdir=live/$e init -backend=false -input=false
              terraform -chdir=live/$e validate
            fi
          done

      # --- tflint ---
      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --version

      - name: tflint (recursive)
        run: |
          set -e
          tflint --init
          tflint --recursive

      # --- trivy config ---
      - name: Install trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -qO- https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.57.0_Linux-64bit.tar.gz | sudo tar zx -C /usr/local/bin trivy
          trivy --version

      - name: Trivy config (IaC scan)
        run: |
          # Fail build on HIGH/CRITICAL
          trivy config --exit-code 1 --severity HIGH,CRITICAL .

  policy:
    name: policy (conftest on plan JSON)
    runs-on: ubuntu-latest
    needs: [lint]

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_$(uname -s)_$(uname -m).tar.gz | tar xz
          sudo mv conftest /usr/local/bin/conftest
          conftest --version

      - name: Policy check (conftest on plan JSON)
        run: |
          set -e
          mkdir -p conftest-plans
          dirs="03-for-each-patterns 04-dynamic-patterns 07-modules"
          for d in $dirs; do
            if [ -d "$d" ]; then
              echo "== conftest $d =="
              terraform -chdir=$d init -backend=false -input=false
              terraform -chdir=$d plan -no-color -input=false -lock=false -out=tfplan
              terraform -chdir=$d show -no-color -json tfplan > conftest-plans/${d//\//_}.tfplan.json
              conftest test conftest-plans/${d//\//_}.tfplan.json -p policy
            fi
          done

      - name: Upload conftest plan JSON artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: conftest-plans
          path: conftest-plans

  integration:
    name: integration (terratest)
    runs-on: ubuntu-latest
    needs: [policy]

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Terratest
        run: |
          cd 11-terratest/test
          go mod tidy
          go test -v -timeout 25m

  apply:
    name: apply (manual, gated)
    runs-on: ubuntu-latest
    # Only available when manually dispatched
    if: github.event_name == 'workflow_dispatch'
    needs: [integration]

    # This is what creates the "approval gate":
    # In GitHub repo settings -> Environments -> create environment "apply"
    # Add required reviewers.
    environment: apply

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,dynamodb,iam,sqs,sns,sts,lambda,apigateway,logs,cloudwatch,events
          AWS_DEFAULT_REGION: us-east-1
        options: >-
          --health-cmd "curl -s http://localhost:4566/_localstack/health | grep -q available"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Apply target (manual)
        run: |
          set -e
          echo "Applying env=${{ inputs.env }} dir=${{ inputs.target_dir }}"
          terraform -chdir=${{ inputs.target_dir }} init -input=false
          terraform -chdir=${{ inputs.target_dir }} plan -no-color -input=false -out=tfplan
          terraform -chdir=${{ inputs.target_dir }} apply -no-color -input=false -auto-approve tfplan